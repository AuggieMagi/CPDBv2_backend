---
- name: Install specific python version
  script: install-python.sh {{ python_version }}
  become: yes
  become_user: "{{ deploy_user }}"

- name: Install virtualenv
  pip: name=virtualenv
  tags: packages

- name: Create the virtualenv
  script: create-env.sh {{ pyenv_root }}/versions/{{ python_version }}/bin/python {{ application_name }}
  become: yes
  become_user: "{{ deploy_user }}"

- name: Ensure gunicorn is installed
  pip: virtualenv={{ virtualenv_path }} name=gunicorn
  become: yes
  become_user: "{{ deploy_user }}"

- name: Create the Gunicorn script file
  template: src=gunicorn_start.j2
            dest={{ virtualenv_path }}/bin/gunicorn_start
            owner={{ deploy_user }}
            group={{ deploy_group }}
            mode=0755
            backup=yes
  tags: deploy

- name: Create Twitterbot start script file
  template: src=twitterbot_start.j2
            dest={{ virtualenv_path }}/bin/twitterbot_start
            owner={{ deploy_user }}
            group={{ deploy_group }}
            mode=0755
            backup=yes
  tags: deploy
  when: run_twitterbot

- name: Create the application log folder
  file: path={{ application_log_dir }}
        owner={{ deploy_user }}
        group={{ deploy_group }}
        mode=0774
        state=directory

- name: Create the application log file
  file: path={{ application_log_file }}
        state=touch
        owner={{ deploy_user }}
        group={{ deploy_group }}

- name: Set permission to the application log file
  file: path={{ application_log_file }}
        owner={{ deploy_user }}
        group={{ deploy_group }}
        mode=0664
        state=file

- name: Create the maintenance page
  template: src=maintenance_off.html
            dest={{ virtualenv_path }}/maintenance_off.html
            mode=0664
