machine:
  python:
    version: 2.7.11
  environment:
    DJANGO_SETTINGS_MODULE: config.settings.test

database:
  post:
    - psql -c "CREATE EXTENSION postgis;" -d circle_test

dependencies:
  override:
    - pip install -r requirements/test.txt
  cache_directories:
    - "elasticsearch-5.1.1"
  post:
    - if [[ ! -e elasticsearch-5.1.1 ]]; then wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.1.1.tar.gz && tar -xvf elasticsearch-5.1.1.tar.gz; fi
    - elasticsearch-5.1.1/bin/elasticsearch: {background: true}
    - curl -O https://cpdbdev.blob.core.windows.net/circleci/google-chrome-stable_current_amd64.deb && sudo dpkg -i google-chrome-stable_current_amd64.deb
    - wget https://chromedriver.storage.googleapis.com/2.32/chromedriver_linux64.zip && unzip chromedriver_linux64.zip && sudo mv chromedriver /usr/local/bin/

test:
  override:
    - flake8
    - coverage run cpdb/manage.py test --noinput --nologcapture
  post:
    - coverage combine
    - coverage report --omit="/home/ubuntu/virtualenvs/*,common/json_serializer.py"
    - coveralls

deployment:
  staging:
    branch: staging
    commands:
      - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test && sudo apt-get update && sudo apt-get install gcc-4.9 g++-4.9 python-dev
      - sudo pip install --upgrade setuptools
      - sudo pip install ansible pycrypto
      - sudo ansible-galaxy install azavea.postgresql
      - sudo chown ubuntu ~/.ansible -R
      - bin/circleci_deploy_staging:
          timeout: 7200
