machine:
  python:
    version: 2.7.11
  environment:
    DJANGO_SETTINGS_MODULE: config.settings.test

database:
  post:
    - psql -c "CREATE EXTENSION postgis;" -d circle_test

dependencies:
  override:
    - pip install -r requirements/test.txt
  cache_directories:
    - "elasticsearch-2.3.5"
  post:
    - if [[ ! -e elasticsearch-2.3.5 ]]; then wget https://download.elastic.co/elasticsearch/elasticsearch/elasticsearch-2.3.5.tar.gz && tar -xvf elasticsearch-2.3.5.tar.gz; fi
    - elasticsearch-2.3.5/bin/elasticsearch: {background: true}

test:
  override:
    - flake8
    - coverage run cpdb/manage.py test --noinput --nologcapture
  post:
    - coverage combine
    - coverage report --omit="/home/ubuntu/virtualenvs/*,common/json_serializer.py"
    - coveralls

deployment:
  staging:
    branch: staging
    commands:
      - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test && sudo apt-get update && sudo apt-get install gcc-4.9 g++-4.9 python-dev
      - sudo pip install ansible
      - sudo ansible-galaxy install azavea.postgresql
      - sudo chown ubuntu ~/.ansible -R
      - bin/circleci_deploy_staging:
          timeout: 1800
