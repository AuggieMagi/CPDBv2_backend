machine:
  python:
    version: 2.7.11
  environment:
    DJANGO_SETTINGS_MODULE: config.settings.test
  post:
    - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test && sudo apt-get update && sudo apt-get install gcc-4.9 g++-4.9

database:
  post:
    - psql -c "CREATE EXTENSION postgis;" -d circle_test

dependencies:
  override:
    - pip install -r requirements/test.txt
    - sudo pip install ansible
    - sudo ansible-galaxy install azavea.postgresql

test:
  override:
    - flake8
    - coverage run cpdb/manage.py test --noinput --nologcapture
  post:
    - coverage combine
    - coverage report --omit="/home/ubuntu/virtualenvs/*,common/json_serializer.py"
    - coveralls

deployment:
  staging:
    branch: staging
    commands:
      - sudo chown ubuntu ~/.ansible -R
      - bin/circle_deploy_staging
