#!/usr/bin/env bash

# Only run rebuild_index and rebuild_search_index if the latest commit message
# has the text `[rebuild_index ...args]` in it.

GIT_COMMIT_MSG=`git log --format=%B -n 1 $CIRCLE_SHA1`

if [[ $GIT_COMMIT_MSG =~ [[]rebuild_index([[:alnum:][:space:]"_./=-"]*)[]] ]]; then
  REBUILD_INDEX="true"
  EXTRA_REBUILD_INDEX=${BASH_REMATCH[1]}
else
  REBUILD_INDEX="false"
  EXTRA_REBUILD_INDEX=""
fi

echo $ANSIBLE_VAULT_PASSWORD > vault_pass.txt

ansible-playbook ansible/staging.yml \
  -i ansible/inventory/staging \
  --tags "deploy" \
  --vault-password-file ./vault_pass.txt \
  --extra-vars "{\"run_rebuild_index\": $REBUILD_INDEX,\"extra_rebuild_index\": $EXTRA_REBUILD_INDEX}"
